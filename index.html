<!DOCTYPE html>
<html>
<style>
    * {
        margin: 0;
        padding: 0;
    }
    /* keep canvas at fixed 800x400 screen size, contents will stretch to fit */
    canvas {
        width: 800px;
        height: 400px;
        image-rendering: pixelated;
        background-color: green;
    }
    input[type=number] {
        width: 5em;
    }
</style>

<script src="util/chroma.js"></script>
<script src="util/Array.prototype.js"></script>
<script src="util/FrameTracker.js"></script>

<script src="ot/SpaceBuffer.js"></script>
<script src="ot/Simulation.js"></script>

<script src="ot/render/DirColors.js"></script>

<!-- (the last render method to be included will become the default method) -->
<script src="ot/render/GrayscaleEnergyBufferRaw.js"></script>
<script src="ot/render/GrayscaleEnergyBufferNormalized.js"></script>
<script src="ot/render/DiffBufferNormalized.js"></script>
<script src="ot/render/AngularVecBuffer.js"></script>
<script src="ot/render/CardinalVecBuffer.js"></script>

<!-- (the last init method to be included will become the default method) -->
<script src="ot/init/Random.js"></script>
<script src="ot/init/ListOfPoints.js"></script>
<script src="ot/init/Square.js"></script>

<div id="fps-counter"></div>
<div>
    Init select:
    <select id="init-select"></select>
    <button id="init-apply">Apply</button>
</div>
<div>
    Sim size:
    <input type="number" id="sim-size-x">
    x
    <input type="number" id="sim-size-y">
    <button id="sim-size-apply">Apply</button>
    <em>(Warning: Large values (>1000) may freeze the page)</em>
</div>
<div>
    <label for="slow-queueframe">Slow frame step</label>
    <input type="checkbox" id="slow-queueframe">
</div>
<div>
    Render select: 
    <select id="buffer-select"></select>
    <select id="vis-select"></select>
    <button id="vis-apply">Apply</button>
</div>

<canvas width="400" height="200"></canvas>

<script>
    var canvas, ctx, sim
    function rebuildSimState() {
        canvas = document.querySelector('canvas')
        ctx = canvas.getContext('2d')
        sim = prepareSimulation(canvas, ctx)
    }
    rebuildSimState()
</script>

<script src="ot/UI.js"></script>

<script>
    // initial conditions, t=0 is energy_prev
    function applyInitSim() {
        const range = 10
        const midx = Math.floor(canvas.width / 2)
        const midy = Math.floor(canvas.height / 2)

        sim.energy_now.fill(0)
        sim.energy_prev.fill(0)

        initSim(sim, range, midx, midy)
    }
    applyInitSim()
</script>

<script>
    /* APP START */
    
    // FPS tracking
    const tracker = new FrameTracker()
    window.queueFrame = queueFrameFast
    queueFrame(runFrame)

    function queueFrameFast(cb) {
        requestAnimationFrame(cb)
    }
    function queueFrameSlow(cb) {
        setTimeout(cb, 500)
    }

    function runFrame() {
        runTimeStep(sim, events)

        // draw
        prepareCanvasBuffer(sim)
        ctx.putImageData(sim.canvas_buffer.buffer, 0, 0)

        sim.ops.swapBuffers()

        tracker.tick((fps) => {
            document.querySelector('#fps-counter').textContent = `${fps} fps`
        })
        queueFrame(runFrame)
    }
</script>
</html>