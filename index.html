<!DOCTYPE html>
<html>
<style>
    * {
        margin: 0;
        padding: 0;
    }
    /* keep canvas at fixed 800x400 screen size, contents will stretch to fit */
    canvas {
        width: 800px;
        height: 400px;
        image-rendering: pixelated;
        background-color: green;
    }
</style>

<script src="util/chroma.js"></script>
<script src="util/Array.prototype.js"></script>
<script src="util/FrameTracker.js"></script>

<script src="ot/SpaceBuffer.js"></script>
<script src="ot/Simulation.js"></script>

<script src="ot/render/DirColors.js"></script>
<script src="ot/render/CardinalVecBuffer.js"></script>
<!-- <script src="ot/render/AngularVecBuffer.js"></script> -->

<!-- <script src="ot/init/Random.js"></script> -->
<!-- <script src="ot/init/ListOfPoints.js"></script> -->
<script src="ot/init/Square.js"></script>

<canvas width="100" height="50"></canvas>
<script>
    const canvas = document.querySelector('canvas')
    const ctx = canvas.getContext('2d')
    var sim = prepareSimulation(canvas, ctx)
</script>

<script>
    /* UI */
    const events = []
    canvas.addEventListener('click', ({ clientX, clientY }) => {
        const simx = (clientX / canvas.clientWidth) * canvas.width
        const simy = (clientY / canvas.clientHeight) * canvas.height

        console.log(simx, simy)
        const { energy_now } = sim
        events.push(() => energy_now.setValueAt(-10, Math.floor(simx), Math.floor(simy)))
    })
</script>

<script>
    // initial conditions, t=0 is energy_prev

    const range = 10
    const midx = Math.floor(canvas.width / 2)
    const midy = Math.floor(canvas.height / 2)

    initSim(sim, range, midx, midy)
</script>

<script>
    /* APP START */
    
    // FPS tracking
    const tracker = new FrameTracker()
    queueFrame(runFrame)

    function queueFrame(cb) {
        // setTimeout(cb, 500)
        requestAnimationFrame(cb)
    }

    function runFrame() {
        runTimeStep(sim, events)

        // draw
        prepareCanvasBuffer(sim)
        ctx.putImageData(sim.canvas_buffer.buffer, 0, 0)

        sim.ops.swapBuffers()

        tracker.tick()
        queueFrame(runFrame)
    }
</script>
</html>